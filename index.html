<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø±Ø§Ø¯ÙŠÙˆ ÙˆÙ„ÙŠØ³ØªØ¹ÙÙ</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="react,env">

// --- Firebase Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyB-ILlMJfQkfCN8ZBashSVgEz-Ok1w1vss",
  authDomain: "walyast3fef.firebaseapp.com",
  projectId: "walyast3fef",
  storageBucket: "walyast3fef.firebasestorage.app",
  messagingSenderId: "646833730084",
  appId: "1:646833730084:web:2926a50695ed8ebefddeb1",
  measurementId: "G-JB4JXZ3ZYL",
  databaseURL: "https://walyast3fef-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig );
const analytics = firebase.analytics();
const database = firebase.database();

const { useState, useEffect, useRef } = React;
// Helper function to get the next track's state
function getNextTrackState(currentIndex) {
    const nextIndex = (currentIndex + 1) % PLAYLIST.length;
    return {
        currentTrack: PLAYLIST[nextIndex],
        currentIndex: nextIndex,
    };
}
// --- UI Components ---
function Listeners({ onlineCount }) {
    return (
        <div className="absolute top-4 left-4 bg-black/20 text-white text-xs px-2 py-1 rounded-full flex items-center z-10">
            <span className="w-2 h-2 bg-red-500 rounded-full mr-2 animate-pulse"></span>
            {onlineCount} Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†
        </div>
    );
}

function CountryStats({ onlineUsers }) {
    const [stats, setStats] = useState([]);

    useEffect(() => {
        const countryCounts = onlineUsers.reduce((acc, user) => {
            const code = user.countryCode || 'XX';
            acc[code] = (acc[code] || 0) + 1;
            return acc;
        }, {});

        const statsArray = Object.entries(countryCounts)
            .map(([code, count]) => ({ code, count }))
            .sort((a, b) => b.count - a.count);

        setStats(statsArray);
    }, [onlineUsers]);

    if (stats.length === 0) return null;

    return (
        <div className="absolute top-12 left-4 bg-black/20 text-white text-xs p-2 rounded-lg z-10 max-w-[150px]">
            <ul className="space-y-1">
                {stats.slice(0, 4).map(({ code, count }) => (
                    <li key={code} className="flex items-center justify-between text-right">
                        <span className="font-bold mr-2">{count}</span>
                        {code === 'XX' ? (
                            <span className="flex items-center">
                                <span className="mr-1"> </span>
                                <span>ğŸŒ</span>
                            </span>
                        ) : (
                            <img 
                                src={`https://flagcdn.com/w20/${code.toLowerCase( )}.png`}
                                width="20"
                                alt={code}
                                className="rounded-sm shadow"
                            />
                        )}
                    </li>
                ))}
            </ul>
        </div>
    );
}

// --- Playlist & Radio Logic ---
const ORIGINAL_PLAYLIST = [
    { url: "audio/xWalyastaafef01.mp3", duration: 2719, title: "Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‚Ø§Ø¡ 1" },
    { url: "audio/xWalyastaafef02.mp3", duration: 2619, title: "Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‚Ø§Ø¡ 2" },
    { url: "audio/xWalyastaafef03.mp3", duration: 3036, title: "Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‚Ø§Ø¡ 3" },
    { url: "audio/xWalyastaafef04.mp3", duration: 2250, title: "Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‚Ø§Ø¡ 4" },
    { url: "audio/xWalyastaafef_LIVE01.mp3", duration: 2714, title: "Ù„Ù‚Ø§Ø¡ 1 - Ù…Ø­Ø§ÙˆØ± Ø§Ù„ØªØºÙŠÙŠØ± ( Ø§Ù„ØªØ­ÙÙŠØ² - Ø§Ù„Ù‚Ø±Ø§Ø± - Ø§Ù„ØªØºÙŠÙŠØ± - Ø§Ù„ØªØ«Ø¨ÙŠØª )" },
    { url: "audio/xWalyastaafef_LIVE02.mp3", duration: 2510, title: "Ù„Ù‚Ø§Ø¡ 2 - Ù…Ø­ÙˆØ± Ø§Ù„Ù‚Ø±Ø§Ø± - Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹ Ø¹Ù† Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ©" },
    { url: "audio/xWalyastaafef_LIVE03.mp3", duration: 2073, title: "Ù„Ù‚Ø§Ø¡ 3 - Ø¨Ø­Ø³ Ø¥Ù† Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ© ÙØ±ØµØ© ØµØ¹Ø¨ ØªØªÙÙˆØª" },
    { url: "audio/xWalyastaafef_LIVE04.mp3", duration: 1859, title: "Ù„Ù‚Ø§Ø¡ 4 - Ø§Ù„Ø£ÙÙƒØ§Ø± Ù…Ø³ÙŠØ·Ø±Ø© Ø¹Ù„ÙŠØ§ ÙˆØ¨ØªÙˆÙ‚Ø¹Ù†ÙŠ" },
    { url: "audio/xWalyastaafef_LIVE05.mp3", duration: 1828, title: "Ù„Ù‚Ø§Ø¡ 5 - Ù…ØºØ§Ù„Ø·Ø§Øª Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† ÙˆØ¹Ù„Ø§Ø¬Ù‡" },
    { url: "audio/xWalyastaafef_LIVE06.mp3", duration: 1989, title: "Ù„Ù‚Ø§Ø¡ 6 - Ø¨Ø®Ø§Ù ØªÙ†Ø²Ù„ Ø¹Ù„ÙŠØ§ Ù…ØµÙŠØ¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ‚ÙˆØ¹" },
    { url: "audio/xWalyastaafef_LIVE07.mp3", duration: 2193, title: "Ø§Ù„Ù„Ù‚Ø§Ø¡ 7 - Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø®ÙˆØ§Ø·Ø± ÙˆØ§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¬Ù†Ø³ÙŠ" },
    { url: "audio/xWalyastaafef_LIVE08.mp3", duration: 2197, title: "Ù„Ù‚Ø§Ø¡ 8 - Ù‡ØªÙØ±Ø¬ ÙˆØ§Ø¨Ù‚Ù‰ Ø£ØªÙˆØ¨" },
    { url: "audio/xWalyastaafef_LIVE09.mp3", duration: 2850, title: "Ø§Ù„Ù„Ù‚Ø§Ø¡ 9 - Ø£Ù†Ø§ Ù‡ÙØ¶Ù„ Ø£Ø¹Ø§Ù†ÙŠ Ø¨Ø¯ÙˆÙ† Ø¬Ù†Ø³ ÙƒØ¯Ù‡ ÙƒØªÙŠØ±ØŸ" },
    { url: "audio/xWalyastaafef_LIVE10.mp3", duration: 1584, title: "Ù„Ù‚Ø§Ø¡ 10 - Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø´Ù…ÙˆÙ„ÙŠ Ù„Ù„Ø¥Ø¨Ø§Ø­ÙŠØ©" },
    { url: "audio/xWalyastaafef_LIVE11.mp3", duration: 1434, title: "Ù„Ù‚Ø§Ø¡ 11 - Ø¹Ù„Ø§Ø¬ Ø§Ù„ÙŠØ£Ø³ ÙˆØ³Ø±Ø¹Ø© Ø§Ù„Ø¥Ø­Ø¨Ø§Ø· Ø®Ù„Ø§Ù„ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ø§ÙÙŠ" },
    { url: "audio/xWalyastaafef_LIVE12.mp3", duration: 2117, title: "Ù„Ù‚Ø§Ø¡ 12 - ÙƒÙŠÙ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„Ø´Ù‡ÙˆØ©" },
    { url: "audio/xWalyastaafef_LIVE13.mp3", duration: 2063, title: "Ø§Ù„Ù„Ù‚Ø§Ø¡ 13 - Ù„ÙŠÙ‡ Ø¨ØªÙ‚Ø¯Ù… ÙØªØ±Ø© ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø¨ØªØ±Ø§Ø¬Ø¹ØŸ" },
    { url: "audio/xWalyastaafef_LIVE14.mp3", duration: 2193, title: "Ù„Ù‚Ø§Ø¡ 14 - Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø®ÙˆÙ ÙˆØ§Ù„Ø±Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¹ØµÙŠØ©" },
    { url: "audio/xWalyastaafef_LIVE15.mp3", duration: 2151, title: "Ù„Ù‚Ø§Ø¡ 15 - Ø§ÙŠÙ‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ Ø·Ø§Ø¹Ø© Ù‚ØµØ§Ø¯ Ù…Ø¹ØµÙŠØ© ÙˆØ§Ù„Ø¯Ù†ÙŠØ§ Ù…Ø§Ø´ÙŠØ©!" },
    { url: "audio/xWalyastaafef_LIVE16.mp3", duration: 2345, title: "Ù„Ù‚Ø§Ø¡ 16 - Ø£Ù†Ø§ Ø¹Ø§ÙŠØ² Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ©" },
    { url: "audio/xWalyastaafef_LIVE17.mp3", duration: 2121, title: "Ù„Ù‚Ø§Ø¡ 17 - Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ© ÙÙ† Ù…Ø´ Ø¹Ù† Ø¹Ù† (Ù…Ø´ Ø¨Ø§Ù„Ø¹Ø§ÙÙŠØ©)" },
    { url: "audio/xWalyastaafef_LIVE18.mp3", duration: 2251, title: "Ù„Ù‚Ø§Ø¡ 18 - Ø£ØªØ¬ÙˆØ² ÙˆÙ„Ø§ Ø£Ø³ØªÙ†Ù‰ Ù„Ù…Ø§ Ø§ØªØ¹Ø§ÙÙ‰ØŸ" },
    { url: "audio/xWalyastaafef_LIVE19.mp3", duration: 1955, title: "Ù„Ù‚Ø§Ø¡ 19 - Ø§Ø²Ø§ÙŠ Ø§ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ØŸ" },
    { url: "audio/xWalyastaafef_LIVE20.mp3", duration: 1978, title: "Ù„Ù‚Ø§Ø¡ 20 - Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø²ÙˆØ§Ø¬ ÙˆØ§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ©" },
    { url: "audio/xWalyastaafef_LIVE21.mp3", duration: 1586, title: "Ù„Ù‚Ø§Ø¡ 21 - Ø®Ø§ÙŠÙ Ø£Ù‚Ø§ÙˆÙ… ÙˆÙÙŠ Ø§Ù„Ø¢Ø®Ø± Ø£Ù†ÙØ¬Ø±" },
    { url: "audio/xWalyastaafef_LIVE22.mp3", duration: 1613, title: "Ù„Ù‚Ø§Ø¡ 22 - Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø·ÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ" },
    { url: "audio/xWalyastaafef_LIVE23.mp3", duration: 2091, title: "Ù„Ù‚Ø§Ø¡ 23 - Ù„ÙŠÙ‡ Ù„Ù…Ø§ Ø¨Ù‚Ø¹ Ø¨Ø³ØªØ­Ù„Ø§Ù‡Ø§ ÙˆÙ…Ø´ Ø¨Ø¹Ø±Ù Ø£ÙˆÙ‚ÙØŸ" },
];

function seededShuffle(array, seed) {
    let currentIndex = array.length, temporaryValue, randomIndex;
    const random = () => {
        var x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
    };
    while (0 !== currentIndex) {
        randomIndex = Math.floor(random() * currentIndex);
        currentIndex -= 1;
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }
    return array;
}

const today = new Date();
const dateSeed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
const PLAYLIST = seededShuffle([...ORIGINAL_PLAYLIST], dateSeed);
const RADIO_EPOCH = 1672531200000;
const totalPlaylistDuration = PLAYLIST.reduce((sum, track) => sum + track.duration, 0);

function getRadioState() {
  const now = Date.now();
  const elapsedSeconds = Math.floor((now - RADIO_EPOCH) / 1000);
  const positionInPlaylist = elapsedSeconds % totalPlaylistDuration;
  let accumulatedTime = 0;
  for (let i = 0; i < PLAYLIST.length; i++) {
    const track = PLAYLIST[i];
    if (positionInPlaylist < accumulatedTime + track.duration) {
      return {
        currentTrack: track,
        positionInTrack: positionInPlaylist - accumulatedTime,
      };
    }
    accumulatedTime += track.duration;
  }
  return { currentTrack: PLAYLIST[0], positionInTrack: 0 };
}


function App() {
  const audioRef = useRef(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [volume, setVolume] = useState(0.7);
  const [currentTime, setCurrentTime] = useState(0);
  const [currentTrack, setCurrentTrack] = useState(null);
  const [isInitialized, setIsInitialized] = useState(false);
  const [currentTrackIndex, setCurrentTrackIndex] = useState(0);
  const nextTrackIndex = (currentTrackIndex + 1) % PLAYLIST.length;
const nextTrackTitle = PLAYLIST[nextTrackIndex].title;
  const [onlineUsers, setOnlineUsers] = useState([]);

  // --- THE FIX IS HERE: Presence logic is now inside useEffect ---
  useEffect(() => {
    let sessionRef; 

    async function getCountry() {
        try {
            const response = await fetch('https://ipapi.co/json/' );
            const data = await response.json();
            return { countryCode: data.country_code, countryName: data.country_name };
        } catch (error) {
            console.error("Could not fetch country", error);
            return { countryCode: 'XX', countryName: 'Unknown' };
        }
    }

    async function setupPresence() {
        const sessionId = Math.random().toString(36).substring(2);
        sessionRef = database.ref('/status/' + sessionId);
        const location = await getCountry();

        const initialData = { 
            state: 'online',
            countryCode: location.countryCode,
            countryName: location.countryName,
            last_seen: firebase.database.ServerValue.TIMESTAMP
        };

        await sessionRef.set(initialData);
        sessionRef.onDisconnect().remove();
    }

    setupPresence();

    const heartbeatInterval = setInterval(() => {
        if (sessionRef) {
            sessionRef.child('last_seen').set(firebase.database.ServerValue.TIMESTAMP);
        }
    }, 15000);

    const statusRef = database.ref('/status');
    const listener = statusRef.on('value', (snapshot) => {
        const now = Date.now();
        const users = [];
        snapshot.forEach(childSnapshot => {
            const user = childSnapshot.val();
            if (user.last_seen && (now - user.last_seen < 35000)) {
                users.push(user);
            } else {
                if (now - user.last_seen > 60000) {
                    childSnapshot.ref.remove();
                }
            }
        });
        setOnlineUsers(users);
    });

    return () => {
        clearInterval(heartbeatInterval);
        statusRef.off('value', listener);
        if (sessionRef) {
            sessionRef.remove();
        }
    };
  }, []); // Empty dependency array ensures this runs only ONCE

  useEffect(() => {
    const initialState = getRadioState();
    if (initialState) {
        const nextState = getNextTrackState(initialState.currentIndex);
        setCurrentTrack(initialState.currentTrack);
        setCurrentTrackIndex(initialState.currentIndex);
        setCurrentTime(initialState.positionInTrack);
        setNextTrack(nextState.currentTrack);
    }
}, []);


  useEffect(() => {
    const audioEl = audioRef.current;
    if (!audioEl || !currentTrack) return;

    // Set the source only when the track actually changes
    if (audioEl.src !== new URL(currentTrack.url, window.location.href).href) {
        audioEl.src = currentTrack.url;
    }

    const handleTimeUpdate = () => setCurrentTime(audioEl.currentTime);
    
    const handleTrackEnd = () => {
        const nextState = getNextTrackState(currentTrackIndex);
        setCurrentTrackIndex(nextState.currentIndex);
        setCurrentTrack(nextState.currentTrack);

        const futureNextState = getNextTrackState(nextState.currentIndex);
        setNextTrack(futureNextState.currentTrack);
    };

    audioEl.addEventListener('timeupdate', handleTimeUpdate);
    audioEl.addEventListener('ended', handleTrackEnd);

    // If isPlaying is true, ensure audio plays
    if (isPlaying) {
        audioEl.play().catch(e => console.error("Autoplay after track end failed", e));
    }

    return () => {
        audioEl.removeEventListener('timeupdate', handleTimeUpdate);
        audioEl.removeEventListener('ended', handleTrackEnd);
    };
}, [currentTrack, isPlaying]); // Re-run when track or play-state changes

  const togglePlay = () => {
    const audioEl = audioRef.current;
    if (!audioEl) return;

    if (isPlaying) {
      audioEl.pause();
      setIsPlaying(false);
      analytics.logEvent('playback_stopped');
    } else {
      if (!isInitialized) {
        const state = getRadioState();
        audioEl.src = state.currentTrack.url;
        audioEl.currentTime = state.positionInTrack;
        setCurrentTrack(state.currentTrack);
        setIsInitialized(true);
      }
      
      audioEl.play()
        .then(() => {
          setIsPlaying(true);
          analytics.logEvent('playback_started', { track_title: currentTrack.title });
        })
        .catch(error => {
          console.error("Playback failed:", error);
          setIsInitialized(false); 
        });
    }
  };

  const handleVolumeChange = (e) => {
    const newVol = parseFloat(e.target.value);
    setVolume(newVol);
    if (audioRef.current) audioRef.current.volume = newVol;
  };

  const formatTime = (s) => {
      if (isNaN(s)) return "0:00";
      return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
  }

  if (!currentTrack) {
    return <div className="flex justify-center items-center h-screen text-white bg-gradient-to-br from-purple-900 to-blue-800">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>;
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-900 to-blue-800 p-4 relative">
      <Listeners onlineCount={onlineUsers.length} />
      <CountryStats onlineUsers={onlineUsers} />
      <audio ref={audioRef} />
      <div className="bg-white/10 backdrop-blur-lg p-6 rounded-2xl text-center w-full max-w-md shadow-lg">
        <h1 className="text-white text-3xl font-bold mb-2">Ø±Ø§Ø¯ÙŠÙˆ ÙˆÙ„ÙŠØ³ØªØ¹ÙÙ</h1>
        <p className="text-purple-200 mb-4">{currentTrack.title}</p>
       <p className="text-purple-300 text-xs mb-4">
    Ø§Ù„ØªØ§Ù„ÙŠ: {nextTrackTitle}
</p>

        <button onClick={togglePlay} className="bg-white text-purple-900 w-20 h-20 rounded-full flex items-center justify-center shadow-lg mb-4 mx-auto">
          {isPlaying ? "â¸ï¸" : "â–¶ï¸"}
        </button>

        <div className="mb-4">
          <div className="flex justify-between text-sm text-purple-200 mb-1">
            <span>{formatTime(currentTime)}</span>
            <span>{formatTime(currentTrack.duration)}</span>
          </div>
          <div className="w-full h-2 bg-white/20 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-purple-500 to-pink-500"
                 style={{ width: `${(currentTime / currentTrack.duration) * 100}%` }}/>
          </div>
        </div>

        <input type="range" min="0" max="1" step="0.01" value={volume} onChange={handleVolumeChange} className="w-full accent-purple-500"/>
        
        <div className="mt-6">
            <a href="https://www.facebook.com/Walyasta3fef" target="_blank" rel="noopener noreferrer" className="text-purple-200 hover:text-white transition-colors">
                <svg className="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path fillRule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clipRule="evenodd" />
                </svg>
            </a>
        </div>
      </div>
    </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>





