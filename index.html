<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>راديو وليستعفف</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="react,env">

// --- Firebase Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyB-ILlMJfQkfCN8ZBashSVgEz-Ok1w1vss",
  authDomain: "walyast3fef.firebaseapp.com",
  projectId: "walyast3fef",
  storageBucket: "walyast3fef.firebasestorage.app",
  messagingSenderId: "646833730084",
  appId: "1:646833730084:web:2926a50695ed8ebefddeb1",
  measurementId: "G-JB4JXZ3ZYL",
  databaseURL: "https://walyast3fef-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig );
const analytics = firebase.analytics();
const database = firebase.database();

// --- Presence & Geolocation System ---
async function getCountry() {
    try {
        const response = await fetch('https://ipapi.co/json/' );
        const data = await response.json();
        return { countryCode: data.country_code, countryName: data.country_name };
    } catch (error) {
        console.error("Could not fetch country", error);
        return { countryCode: 'XX', countryName: 'Unknown' };
    }
}

async function setupPresence() {
    const sessionId = Math.random().toString(36).substring(2);
    const sessionRef = database.ref('/status/' + sessionId);
    const location = await getCountry();

    sessionRef.set({ 
        state: 'online',
        countryCode: location.countryCode,
        countryName: location.countryName
    });
    sessionRef.onDisconnect().remove();
}

setupPresence();


const { useState, useEffect, useRef } = React;

// --- UI Components ---
function Listeners() {
    const [count, setCount] = useState(0);
    useEffect(() => {
        const statusRef = database.ref('/status');
        const listener = statusRef.on('value', (snapshot) => {
            setCount(snapshot.numChildren());
        });
        return () => statusRef.off('value', listener);
    }, []);

    return (
        <div className="absolute top-4 left-4 bg-black/20 text-white text-xs px-2 py-1 rounded-full flex items-center z-10">
            <span className="w-2 h-2 bg-red-500 rounded-full mr-2 animate-pulse"></span>
            {count} مستمع الآن
        </div>
    );
}

function CountryFlags() {
    const [countries, setCountries] = useState([]);
    useEffect(() => {
        const statusRef = database.ref('/status');
        const listener = statusRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const countryCodes = Object.values(data).map(user => user.countryCode);
                const uniqueCodes = [...new Set(countryCodes)]; // Remove duplicates
                setCountries(uniqueCodes);
            } else {
                setCountries([]);
            }
        });
        return () => statusRef.off('value', listener);
    }, []);

    if (countries.length === 0) return null;

    return (
        <div className="absolute top-4 right-4 flex space-x-2 rtl:space-x-reverse z-10">
            {countries.slice(0, 5).map(code => ( // Show max 5 flags
                <img 
                    key={code}
                    src={`https://flagcdn.com/w20/${code.toLowerCase( )}.png`}
                    width="20"
                    alt={code}
                    className="rounded-sm shadow"
                    title={code}
                />
            ))}
        </div>
    );
}


// --- Playlist & Radio Logic (No changes here) ---
const ORIGINAL_PLAYLIST = [
    { url: "audio/xWalyastaafef01.mp3", duration: 2719, title: "الكورس الأساسي لقاء 1" },
    { url: "audio/xWalyastaafef02.mp3", duration: 2619, title: "الكورس الأساسي لقاء 2" },
    { url: "audio/xWalyastaafef03.mp3", duration: 3036, title: "الكورس الأساسي لقاء 3" },
    { url: "audio/xWalyastaafef04.mp3", duration: 2250, title: "الكورس الأساسي لقاء 4" },
    { url: "audio/xWalyastaafef_LIVE01.mp3", duration: 2714, title: "لقاء 1 - محاور التغيير ( التحفيز - القرار - التغيير - التثبيت )" },
    { url: "audio/xWalyastaafef_LIVE02.mp3", duration: 2510, title: "لقاء 2 - محور القرار - قرار الإقلاع عن الإباحية" },
    { url: "audio/xWalyastaafef_LIVE03.mp3", duration: 2073, title: "لقاء 3 - بحس إن الإباحية فرصة صعب تتفوت" },
    { url: "audio/xWalyastaafef_LIVE04.mp3", duration: 1859, title: "لقاء 4 - الأفكار مسيطرة عليا وبتوقعني" },
    { url: "audio/xWalyastaafef_LIVE05.mp3", duration: 1828, title: "لقاء 5 - مغالطات الإدمان وعلاجه" },
    { url: "audio/xWalyastaafef_LIVE06.mp3", duration: 1989, title: "لقاء 6 - بخاف تنزل عليا مصيبة بعد الوقوع" },
    { url: "audio/xWalyastaafef_LIVE07.mp3", duration: 2193, title: "اللقاء 7 - التعامل مع الخواطر والتفكير الجنسي" },
    { url: "audio/xWalyastaafef_LIVE08.mp3", duration: 2197, title: "لقاء 8 - هتفرج وابقى أتوب" },
    { url: "audio/xWalyastaafef_LIVE09.mp3", duration: 2850, title: "اللقاء 9 - أنا هفضل أعاني بدون جنس كده كتير؟" },
    { url: "audio/xWalyastaafef_LIVE10.mp3", duration: 1584, title: "لقاء 10 - العلاج الشمولي للإباحية" },
    { url: "audio/xWalyastaafef_LIVE11.mp3", duration: 1434, title: "لقاء 11 - علاج اليأس وسرعة الإحباط خلال رحلة التعافي" },
    { url: "audio/xWalyastaafef_LIVE12.mp3", duration: 2117, title: "لقاء 12 - كيف نتعامل مع الشعور بالشهوة" },
    { url: "audio/xWalyastaafef_LIVE13.mp3", duration: 2063, title: "اللقاء 13 - ليه بتقدم فترة وبعدين بتراجع؟" },
    { url: "audio/xWalyastaafef_LIVE14.mp3", duration: 2193, title: "لقاء 14 - الفرق بين الخوف والرعب من المعصية" },
    { url: "audio/xWalyastaafef_LIVE15.mp3", duration: 2151, title: "لقاء 15 - ايه المشكلة؟ طاعة قصاد معصية والدنيا ماشية!" },
    { url: "audio/xWalyastaafef_LIVE16.mp3", duration: 2345, title: "لقاء 16 - أنا عايز خطوات عملية لعلاج الإباحية" },
    { url: "audio/xWalyastaafef_LIVE17.mp3", duration: 2121, title: "لقاء 17 - علاج الإباحية فن مش عن عن (مش بالعافية)" },
    { url: "audio/xWalyastaafef_LIVE18.mp3", duration: 2251, title: "لقاء 18 - أتجوز ولا أستنى لما اتعافى؟" },
    { url: "audio/xWalyastaafef_LIVE19.mp3", duration: 1955, title: "لقاء 19 - ازاي اتعامل مع أعراض الانسحاب؟" },
    { url: "audio/xWalyastaafef_LIVE20.mp3", duration: 1978, title: "لقاء 20 - الفرق بين الزواج والإباحية" },
    { url: "audio/xWalyastaafef_LIVE21.mp3", duration: 1586, title: "لقاء 21 - خايف أقاوم وفي الآخر أنفجر" },
    { url: "audio/xWalyastaafef_LIVE22.mp3", duration: 1613, title: "لقاء 22 - الفرق بين التبطيل والتعافي" },
    { url: "audio/xWalyastaafef_LIVE23.mp3", duration: 2091, title: "لقاء 23 - ليه لما بقع بستحلاها ومش بعرف أوقف؟" },
];

function seededShuffle(array, seed) { /* ... */ }
const today = new Date();
const dateSeed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
const PLAYLIST = seededShuffle([...ORIGINAL_PLAYLIST], dateSeed);
const RADIO_EPOCH = 1672531200000;
const totalPlaylistDuration = PLAYLIST.reduce((sum, track) => sum + track.duration, 0);
function getRadioState() { /* ... */ }


function App() {
  const audioRef = useRef(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [volume, setVolume] = useState(0.7);
  const [currentTime, setCurrentTime] = useState(0);
  const [currentTrack, setCurrentTrack] = useState(null);
  const [isInitialized, setIsInitialized] = useState(false);

  useEffect(() => { /* ... */ }, []);
  useEffect(() => { /* ... */ }, [isPlaying]);
  const togglePlay = () => { /* ... */ };
  const handleVolumeChange = (e) => { /* ... */ };
  const formatTime = (s) => { /* ... */ };

  if (!currentTrack) {
    return <div className="flex justify-center items-center h-screen text-white bg-gradient-to-br from-purple-900 to-blue-800">جارٍ التحميل...</div>;
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-900 to-blue-800 p-4 relative">
      <Listeners />
      <CountryFlags />
      <audio ref={audioRef} />
      <div className="bg-white/10 backdrop-blur-lg p-6 rounded-2xl text-center w-full max-w-md shadow-lg">
        <h1 className="text-white text-3xl font-bold mb-2">راديو وليستعفف</h1>
        <p className="text-purple-200 mb-4">{currentTrack.title}</p>

        <button onClick={togglePlay} className="bg-white text-purple-900 w-20 h-20 rounded-full flex items-center justify-center shadow-lg mb-4 mx-auto">
          {isPlaying ? "⏸️" : "▶️"}
        </button>

        <div className="mb-4">
          <div className="flex justify-between text-sm text-purple-200 mb-1">
            <span>{formatTime(currentTime)}</span>
            <span>{formatTime(currentTrack.duration)}</span>
          </div>
          <div className="w-full h-2 bg-white/20 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-purple-500 to-pink-500"
                 style={{ width: `${(currentTime / currentTrack.duration) * 100}%` }}/>
          </div>
        </div>

        <input type="range" min="0" max="1" step="0.01" value={volume} onChange={handleVolumeChange} className="w-full accent-purple-500"/>
        
        <div className="mt-6">
            <a href="https://www.facebook.com/Walyasta3fef" target="_blank" rel="noopener noreferrer" className="text-purple-200 hover:text-white transition-colors">
                <svg className="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path fillRule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clipRule="evenodd" />
                </svg>
            </a>
        </div>
      </div>
    </div>
   );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
